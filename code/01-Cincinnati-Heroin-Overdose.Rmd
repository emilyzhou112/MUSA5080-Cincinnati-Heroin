---
title: "Geospatial Risk Prediction for Persistent Opioid-Involved Overdose Hotspots in Cincinnati Ohio"
author: "Emily Zhou, EChin Li"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: simplex
    toc: yes
    toc_float: yes
    code_folding: hide
    code_download: yes
editor_options:
  markdown:
    wrap: sentence
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```


Version 1.0 \| First Created Nov 17, 2023 \| Updated Dec 1, 2023

Keywords: K Nearest Neighbors, Moran’s I, Getis-Ord Gi*, Kernel Density Estimation, Random K-fold Cross Validation, Logistic Regression, Poisson Regression, ROC Curve, Principal Component Analysis, Multi-Criteria Analysis, Health Geography


# Introduction


```{r library and setup}

library(tidyverse)
library(tidycensus)
library(sf)
library(lubridate)
library(tigris)
library(mapview)
library(sfdep)
library(spdep)
library(caret)
library(kableExtra)
library(knitr)
library(here)
library(viridis)
library(FNN)
library(stats)
library(factoextra)
library(plotROC)
library(classInt)
library(raster)
library(spatstat.explore)
library(leaflet)

options(tigris_class = "sf")
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
tidycensus::census_api_key("e79f3706b6d61249968c6ce88794f6f556e5bf3d", overwrite = TRUE)

```

# Data

```{r heroin data, message=FALSE, warning=FALSE, results='hide'}

heroin <- read.csv(here("data", "public", "Cincinnati_Fire_Incidents__CAD___including_EMS__ALS_BLS_.csv"))
cincinnati <- st_read(here("data", "public", "Cincinnati_City_Boundary.geojson")) %>% st_transform("EPSG:3735")

heroin <- heroin %>% 
  filter(CFD_INCIDENT_TYPE_GROUP != "NON-PROTOCOL PROBLEM TYPES") %>% 
  filter(is.na(LATITUDE_X) == FALSE & is.na(LONGITUDE_X) == FALSE) %>%  # remove incidents withouth spatial info
  filter(is.na(DISPOSITION_TEXT) == FALSE         # remove record with un-associated disposition codes
         & CFD_INCIDENT_TYPE_GROUP !="CN: CANCEL" # remove records from canceled calls, false alarm, and duplication
         & CFD_INCIDENT_TYPE_GROUP !="CANCEL INCIDENT" 
         & CFD_INCIDENT_TYPE_GROUP !="CN: CANCEL,DEF: DEFAULT"
         & CFD_INCIDENT_TYPE_GROUP !="CN: CANCEL,EMSF: FALSE"
         & CFD_INCIDENT_TYPE_GROUP !="CN: CANCEL,DUPF: DUPLICATE"
         & CFD_INCIDENT_TYPE_GROUP !="CN: CANCEL,FALA: FIRE FALSE AC"
         & CFD_INCIDENT_TYPE_GROUP !="CN: CANCEL,MEDD: MT DISREGARDE"
         & CFD_INCIDENT_TYPE_GROUP !="DUPF: DUPLICATE"
         & CFD_INCIDENT_TYPE_GROUP !="DUPLICATE INCIDENT"
         & CFD_INCIDENT_TYPE_GROUP !="MAL: SYSTEM MALFUNCTION") %>% 
  mutate(time = mdy_hms(CREATE_TIME_INCIDENT, tz = "UTC"),  
         year_column = year(time)) %>% 
  st_as_sf(., coords = c("LONGITUDE_X", "LATITUDE_X"), crs = 4326) %>% 
  st_transform("EPSG:3735") %>% 
  st_intersection(cincinnati %>% select(OBJECTID),.) %>%   # remove incidents outside of study area
  filter(year_column %in% c(2016, 2017, 2018, 2019, 2020))


```


```{r medical resource data, message=FALSE, warning=FALSE}

hospitals <- st_read(here("data","public", "Hospitals.geojson"))
hospitals <- hospitals %>% 
  filter(STATE == "OH" & CITY == "CINCINNATI") %>% 
  st_transform("EPSG:3735") # select those only in Cincinnati


rehab <- read.csv(here("data", "public", "rehabilitation.csv"))
rehab <- rehab %>% 
  filter(is.na(Latitude) == FALSE & is.na(Longitude) == FALSE) %>%
  st_as_sf(., coords = c("Longitude", "Latitude"), crs = 4326) %>% 
  st_transform("EPSG:3735")

```

Specific crimes were selected for inclusion in analyses based on having been identified in the literature as a spatial risk factor for drug overdose or substance use behavior or for having a theoretical relationship with drug overdose. 

```{r crime data, message=FALSE, warning=FALSE}

crime <- read.csv(here("data", "private", "PDI__Police_Data_Initiative__Crime_Incidents.csv"))
crime_list <- c("AGGRAVATED ASSAULT", "BURGLARY", "BREAKING AND ENTERING", "ROBBERY", "DOMESTIC VIOLENCE", "MURDER	", "RAPE", "THEFT")
crime <- crime %>% 
  filter(OFFENSE %in% crime_list) %>% 
  filter(is.na(LATITUDE_X) == FALSE & is.na(LONGITUDE_X) == FALSE) %>%
  st_as_sf(., coords = c("LONGITUDE_X", "LATITUDE_X"), crs = 4326) %>% 
  st_transform("EPSG:3735") %>% 
  mutate(time = mdy_hms(DATE_REPORTED, tz = "UTC"),  
         year = year(time)) %>% 
  filter(year %in% c(2016, 2017, 2018, 2019, 2020))

```


```{r 311 complaints data, warning=FALSE, message=FALSE}

complaints <- read_csv(here("data", "private", "Cincinnati_311__Non-Emergency__Service_Requests.csv"))
complaints <- complaints %>% 
  filter(is.na(LATITUDE) == FALSE & is.na(LONGITUDE) == FALSE) %>%
  st_as_sf(., coords = c("LONGITUDE", "LATITUDE"), crs = 4326) %>% 
  st_transform("EPSG:3735") %>% 
  mutate(time = mdy_hms(REQUESTED_DATE, tz = "UTC"),  
         year = year(time)) %>% 
  filter(year %in% c(2016, 2017, 2018, 2019, 2020))

```


The connection between substance use and built environment variables (access to public restrooms, access to pharmacies, and driving distance to services, defined in our study as fast-food restaurants, gas stations, and highway exits) are also important. Public restrooms are associated with people who inject drugs (PWID) because many people (one study estimates 48%) use drugs in these spaces.Pharmacies represent an important access variable for several reasons. During the initial wave of the overdose crisis, pharmaceutical prescriptions, either legitimate, diverted, or potentially inappropriate, fed the opioid supply. In addition, naloxone (a medication to reverse an opioid overdose) is available at pharmacies without a prescription, although this provision may vary by neighborhood socio-demographic levels.

```{r built environment data, warning=FALSE, message=FALSE}
# gas station
fuel <- st_read(here("data", "public", "fuel.geojson")) %>% st_transform("EPSG:3735")

# fast food restaurant 
fastfood <- st_read(here("data", "public", "fastfood.geojson")) %>% st_centroid() %>% st_transform("EPSG:3735")

# public parks
parks <- st_read(here("data", "public", "parks.geojson")) %>% st_transform("EPSG:3735") %>% st_centroid()

# pharmacy
pharmacy <- st_read(here("data","public", "pharmacy.geojson")) %>% st_transform("EPSG:3735") %>% st_centroid()
```


```{r census data, warning=FALSE, message=FALSE, results='hide', cache=TRUE}

cincinnati20 <- get_acs(geography = "tract", 
          variables = c(
            "B01001_001E", # total population
            "B01001_002E", # total male
            "B01001_011E", # male 25-29
            "B01001_012E",
            "B01001_013E",
            "B01001_014E",
            "B01001_015E",
            "B01001_016E", # male 50-54
            "B01001_026E", # total female
            "B01001_035E", # female 25-29
            "B01001_036E",
            "B01001_037E",
            "B01001_038E",
            "B01001_039E",
            "B01001_040E", # female 50-54
            "B02001_002E", # white population
            "B02001_003E", # black population
            "B02001_005E", # asian population
            "B03002_012E", # latinx population
            "B19013_001E", # median household income
            "B06012_002E", # poverty
            "B06009_005E" # bachelor
            ), 
          year=2020, state="OH", county="Hamilton", 
          geometry=TRUE, output="wide") %>%
  st_transform("EPSG:3735")

cincinnati_tracts <- st_read(here("data", "public", "cincinnati_tracts.geojson")) %>% st_transform("EPSG:3735")

cincinnati_tracts <- cincinnati_tracts %>% st_drop_geometry() %>% dplyr::select(GEOID) %>% as.list(GEOID)

cincinnati20 <- cincinnati20 %>% 
  filter(GEOID %in% cincinnati_tracts$GEOID) %>% 
  rename(Totalpop = B01001_001E,
         MedHHInc = B19013_001E) %>% 
  mutate(pop25_54 = B01001_011E + B01001_012E + B01001_013E + B01001_014E + B01001_015E + B01001_016E + B01001_035E + B01001_036E + B01001_037E + B01001_038E+ B01001_039E + B01001_040E) %>% 
  mutate(MF_ratio = B01001_002E / B01001_026E) %>% 
  mutate(race_ratio = B02001_002E / (B02001_003E + B02001_005E + B03002_012E)) %>% 
  mutate(pctPoverty = B06012_002E / Totalpop) %>% 
  mutate(pctBachelor = B06009_005E / Totalpop) %>% 
  dplyr::select(pop25_54, Totalpop, MedHHInc, GEOID, MF_ratio, race_ratio, pctPoverty, pctBachelor)


```
# Exploratory Data Analysis

# Poission Regression

```{r create fishnet}
fishnet <- st_make_grid(cincinnati,
               cellsize = 820, 
               square = TRUE) %>%
  .[cincinnati] %>%           
  st_sf() %>%
  mutate(uniqueID = 1:n())

ggplot() +
  geom_sf(data=fishnet, color="black", fill="#FFF5EE") +
  labs(title = "Fishnet of Cincinnati") +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks =element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, linewidth=0.8)
        )
```


```{r splitting train and test}

heroinTrain <- heroin %>% 
  filter(year_column %in% c(2016, 2017, 2018))
heroin19 <- heroin %>% 
  filter(year_column == 2019)
heroin20 <- heroin %>% 
  filter(year_column == 2020)

crimeTrain <- crime %>% 
  filter(year %in% c(2016, 2017, 2018))
crime19 <- crime %>% 
  filter(year == 2019)
crime20 <- crime %>% 
  filter(year == 2020)

complaintTrain <- complaints %>% 
  filter(year %in% c(2016, 2017, 2018))
complaint19 <- complaints %>% 
  filter(year == 2019)
complaint20 <- complaints%>% 
  filter(year == 2020)

```


```{r preparing training set}
# add heroin in net
heroinTrain_net <- 
  dplyr::select(heroinTrain) %>%  
  mutate(countHeroin = 1) %>% 
  aggregate(., fishnet, sum) %>%
  mutate(countHeroin = replace_na(countHeroin, 0),
         uniqueID = 1:n(), 
         cvID = sample(round(nrow(fishnet) / 24), 
                       size=nrow(fishnet), replace = TRUE))

# adding crime to net
heroinTrain_net <- heroinTrain_net %>% 
  st_join(crimeTrain, ., join=st_within) %>% 
  st_drop_geometry() %>%
  group_by(uniqueID) %>%
  summarize(Crimecount = n()) %>%
    left_join(heroinTrain_net, . ) %>%
    st_sf() %>%
  mutate(Crimecount = ifelse(is.na(Crimecount), 0, Crimecount))

# add 311 to net
heroinTrain_net <- heroinTrain_net %>% 
  st_join(complaintTrain, ., join=st_within) %>% 
  st_drop_geometry() %>%
  group_by(uniqueID) %>%
  summarize(Complaintscount = n()) %>%
    left_join(heroinTrain_net, . ) %>%
    st_sf() %>%
  mutate(Complaintscount = ifelse(is.na(Complaintscount), 0, Complaintscount))
```


```{r test sets}

# 2019 test sets
heroin19_net <- 
  dplyr::select(heroin19) %>%  
  mutate(countHeroin = 1) %>% 
  aggregate(., fishnet, sum) %>%
  mutate(countHeroin = replace_na(countHeroin, 0),
         uniqueID = 1:n(), 
         cvID = sample(round(nrow(fishnet) / 24), 
                       size=nrow(fishnet), replace = TRUE))

heroin19_net <- heroin19_net %>% 
  st_join(crime19, ., join=st_within) %>% 
  st_drop_geometry() %>%
  group_by(uniqueID) %>%
  summarize(Crimecount = n()) %>%
    left_join(heroin19_net, . ) %>%
    st_sf() %>%
  mutate(Crimecount = ifelse(is.na(Crimecount), 0, Crimecount))

heroin19_net <- heroin19_net %>% 
  st_join(complaint19, ., join=st_within) %>% 
  st_drop_geometry() %>%
  group_by(uniqueID) %>%
  summarize(Complaintscount = n()) %>%
    left_join(heroin19_net, . ) %>%
    st_sf() %>%
  mutate(Complaintscount = ifelse(is.na(Complaintscount), 0, Complaintscount))


# 2020 test set
heroin20_net <- 
  dplyr::select(heroin20) %>%  
  mutate(countHeroin = 1) %>% 
  aggregate(., fishnet, sum) %>%
  mutate(countHeroin = replace_na(countHeroin, 0),
         uniqueID = 1:n(), 
         cvID = sample(round(nrow(fishnet) / 24), 
                       size=nrow(fishnet), replace = TRUE))

heroin20_net <- heroin20_net %>% 
  st_join(crime20, ., join=st_within) %>% 
  st_drop_geometry() %>%
  group_by(uniqueID) %>%
  summarize(Crimecount = n()) %>%
    left_join(heroin20_net, . ) %>%
    st_sf() %>%
  mutate(Crimecount = ifelse(is.na(Crimecount), 0, Crimecount))

heroin20_net <- heroin20_net %>% 
  st_join(complaint20, ., join=st_within) %>% 
  st_drop_geometry() %>%
  group_by(uniqueID) %>%
  summarize(Complaintscount = n()) %>%
    left_join(heroin20_net, . ) %>%
    st_sf() %>%
  mutate(Complaintscount = ifelse(is.na(Complaintscount), 0, Complaintscount))
```


```{r running poission}

poissionTrain <- glm(countHeroin ~ Crimecount + Complaintscount, family = "poisson",
                      data = heroinTrain_net)

Prediction19 <-
  mutate(heroin19_net, Prediction = predict(poissionTrain, heroin19_net, type = "response")) %>% 
  mutate(Error = countHeroin - Prediction) %>% 
  mutate(MAE = mean(abs(Error)))


Prediction20 <-
  mutate(heroin20_net, Prediction = predict(poissionTrain, heroin20_net, type = "response")) %>% 
  mutate(Error = countHeroin - Prediction) %>% 
  mutate(MAE = mean(abs(Error)))
```


# Getis Ord Spatial Hotspot

```{r add heroin to fishnet}
heroin_net <- 
  dplyr::select(heroin) %>%  
  mutate(countHeroin = 1) %>% 
  aggregate(., fishnet, sum) %>%
  mutate(countHeroin = replace_na(countHeroin, 0),
         uniqueID = 1:n(), 
         cvID = sample(round(nrow(fishnet) / 24), 
                       size=nrow(fishnet), replace = TRUE))

ggplot() +
  geom_sf(data = heroin_net, aes(fill = countHeroin), color = NA) +
  scale_fill_viridis(option = "magma", name = "Heroin Counts") +
  labs(title = "Count of Heroin Overdose for the Fishnet") +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks =element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, linewidth=0.8)
        )
```

```{r jenks break}
breaks <- classIntervals(heroin_net$countHeroin, n = 5, style = "jenks")

ggplot() +
  geom_sf(data = heroin_net, aes(fill = countHeroin), color = NA) +
  scale_fill_viridis(option = "magma", breaks = breaks$brks, labels = NULL)  + 
labs(title = "Count of Heroin Overdose for the Fishnet") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.subtitle = element_text(size = 9, face = "italic"),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill = NA, linewidth = 0.8)
  )
```


```{r global moran's I}

coords <-  st_coordinates(heroin_net %>% st_centroid()) 
neighborList <- knn2nb(knearneigh(coords, 4))
spatialWeights <- nb2listw(neighborList, style="W")

moranTest <- moran.mc(heroin_net$countHeroin, 
                      spatialWeights, nsim = 999)

ggplot(as.data.frame(moranTest$res[c(1:999)]), aes(moranTest$res[c(1:999)])) +
  geom_histogram(binwidth = 0.01, fill = "#124E78") +
  geom_vline(aes(xintercept = moranTest$statistic), colour = "#6E0E0A" ,lwd=1) +
  labs(title = "Observed and Permuted Moran's I for Stations with Most Rides",
       subtitle = "Observed Moran's I in Red",
       x = "Moran's I",
       y = "Count") +
  theme_light() +   
theme(plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"), 
        axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8), 
        axis.title=element_text(size=10))

```

```{r local moran I}

neigh_nbs <- heroin_net %>% 
  mutate(
    nb = st_contiguity(geometry),  # neighbors share border    
    wt = st_weights(nb), # row-standardized weights              
    neigh_lag = st_lag(countHeroin, nb, wt)  # calculate spatial lag of mean sale price
  )

gi_hot_spots <- neigh_nbs %>% 
  mutate(Gi = local_g_perm(countHeroin, nb, wt, nsim = 999)) %>% 
  unnest(Gi) 

gi_hot_spots <- gi_hot_spots %>%  
  dplyr::select(gi, p_folded_sim, uniqueID) |> 
  mutate(
    classification = case_when(
      # Classify based on the following criteria:
      gi > 0 & p_folded_sim <= 0.01 ~ "Very hot",
      gi > 0 & p_folded_sim <= 0.05 ~ "Hot",
      gi > 0 & p_folded_sim <= 0.1 ~ "Somewhat hot",
      gi < 0 & p_folded_sim <= 0.01 ~ "Very cold",
      gi < 0 & p_folded_sim <= 0.05 ~ "Cold",
      gi < 0 & p_folded_sim <= 0.1 ~ "Somewhat cold",
      TRUE ~ "Insignificant"
    ),    # Convert 'classification' into a factor for easier plotting
    classification = factor(
      classification,
      levels = c("Very hot", "Hot", "Somewhat hot",
                 "Insignificant",
                 "Somewhat cold", "Cold", "Very cold")
    )
  )

gi_hot_spots %>% 
  ggplot() + 
  geom_sf(aes(fill = classification), color = "black", lwd = 0.1) +
    scale_fill_brewer(type = "div", palette = 5) +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks =element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, linewidth=0.8)
        )

heroin_net <- gi_hot_spots %>% 
  mutate(hotspot = ifelse(classification %in% c("Very hot", "Hot", "Somewhat hot"), 1, 0)) %>% 
  st_drop_geometry() %>% 
  left_join(heroin_net, ., by = "uniqueID")
```

# Simple Logistic Regression

```{r adding risk factors to net}

# adding crime to net
heroin_net <- heroin_net %>% 
  st_join(crime, ., join=st_within) %>% 
  st_drop_geometry() %>%
  group_by(uniqueID) %>%
  summarize(Crimecount = n()) %>%
    left_join(heroin_net, . ) %>%
    st_sf() %>%
  mutate(Crimecount = ifelse(is.na(Crimecount), 0, Crimecount))

# add 311 to net
heroin_net <- heroin_net %>% 
  st_join(complaints, ., join=st_within) %>% 
  st_drop_geometry() %>%
  group_by(uniqueID) %>%
  summarize(Complaintscount = n()) %>%
    left_join(heroin_net, . ) %>%
    st_sf() %>%
  mutate(Complaintscount = ifelse(is.na(Complaintscount), 0, Complaintscount))

net_centroid <- st_centroid(heroin_net) %>% st_transform('ESRI:102728')

# add hospitals
heroin_net <- heroin_net %>% 
  left_join(net_centroid %>% 
              mutate(hospital.nn = nn_function(st_coordinates(net_centroid), 
                                           st_coordinates(hospitals), 1)*0.3048) %>% 
              st_drop_geometry() %>% dplyr::select(hospital.nn, uniqueID), 
            by = "uniqueID")

# add rehab center
heroin_net <- heroin_net %>% 
  left_join(net_centroid %>% 
              mutate(rehab.nn = nn_function(st_coordinates(net_centroid), 
                                           st_coordinates(rehab), 1)*0.3048) %>% 
              st_drop_geometry() %>% dplyr::select(rehab.nn, uniqueID), 
            by = "uniqueID")

# add pharmacy
heroin_net <- heroin_net %>% 
  left_join(net_centroid %>% 
              mutate(pharm.nn = nn_function(st_coordinates(net_centroid), 
                                           st_coordinates(pharmacy), 1)*0.3048) %>% 
              st_drop_geometry() %>% dplyr::select(pharm.nn, uniqueID), 
            by = "uniqueID")


# add gas station
heroin_net <- heroin_net %>% 
  left_join(net_centroid %>% 
              mutate(fuel.nn = nn_function(st_coordinates(net_centroid), 
                                           st_coordinates(fuel), 2)*0.3048) %>% 
              st_drop_geometry() %>% dplyr::select(fuel.nn, uniqueID), 
            by = "uniqueID")

# add fast food restaurant
heroin_net <- heroin_net %>% 
  left_join(net_centroid %>% 
              mutate(fast.nn = nn_function(st_coordinates(net_centroid), 
                                           st_coordinates(fastfood), 2)*0.3048) %>% 
              st_drop_geometry() %>% dplyr::select(fast.nn, uniqueID), 
            by = "uniqueID")

# add parks
heroin_net <- heroin_net %>% 
  left_join(net_centroid %>% 
              mutate(parks.nn = nn_function(st_coordinates(net_centroid), 
                                           st_coordinates(parks), 2)*0.3048) %>% 
              st_drop_geometry() %>% dplyr::select(parks.nn, uniqueID), 
            by = "uniqueID")


# add demographic vars
heroin_net <- heroin_net %>% 
  left_join(net_centroid %>% 
              select(uniqueID) %>% 
              st_intersection(cincinnati20) %>% 
              st_drop_geometry() %>% select(-GEOID), by = "uniqueID") %>% 
  filter(is.na(pop25_54) == FALSE)
```

```{r logistic without cv}

kitchensink <- glm(hotspot ~ .,
                  data=heroin_net %>% 
                    st_drop_geometry() %>% 
                    dplyr::select(hotspot, Crimecount, Complaintscount, pharm.nn, hospital.nn, fast.nn, fuel.nn, rehab.nn, parks.nn, pop25_54, MedHHInc, MF_ratio, race_ratio, pctPoverty, pctBachelor), family="binomial" (link="logit"))

summary(kitchensink)
```

# Logistic Regression with CV

```{r logit function}

logitCV <- function(dataset, id, dependentVariable, indVariables) {
  
  allPredictions <- data.frame()
  cvID_list <- unique(dataset[[id]])

  for (i in cvID_list) {
    
    thisFold <- i
    cat("This hold out fold is", thisFold, "\n")
    
    fold.train <- filter(dataset, dataset[[id]] != thisFold) %>% as.data.frame() %>% 
      dplyr::select(id, geometry, all_of(indVariables),
                    all_of(dependentVariable))
    fold.test  <- filter(dataset, dataset[[id]] == thisFold) %>% as.data.frame() %>% 
      dplyr::select(id, geometry, all_of(indVariables),
                    all_of(dependentVariable))
    
    form_parts <- paste0(dependentVariable, " ~ ", paste0(indVariables, collapse = "+"))
    form <- as.formula(form_parts)
    regression <- glm(form, data = fold.train %>%
                        dplyr::select(-geometry, -id), family="binomial" (link="logit"))
    
    thisPrediction <-
      mutate(fold.test, Prediction = predict(regression, fold.test, type = "response"))
    
    allPredictions <-
      rbind(allPredictions, thisPrediction)
    
  }
  return(st_sf(allPredictions))
}

```

```{r logistic with CV}

reg.vars <- c("Crimecount", "Complaintscount", "pharm.nn", "hospital.nn", "fast.nn", "fuel.nn", "rehab.nn", "parks.nn", "pop25_54", "MedHHInc", "MF_ratio", "race_ratio", "pctPoverty", "pctBachelor")


kitchensink.logit.cv <- logitCV (
  dataset = heroin_net,
  id = "cvID",
  dependentVariable = "hotspot",
  indVariables = reg.vars) %>%
    dplyr::select(cvID = cvID, hotspot, Prediction, geometry)

kitchensink.logit.cv <- kitchensink.logit.cv %>% 
  mutate(PredictionCat  = as.factor(ifelse(kitchensink.logit.cv$Prediction > 0.5 , 1, 0))) %>% 
  mutate(hotspot = as.factor(hotspot))

caret::confusionMatrix(kitchensink.logit.cv$hotspot, kitchensink.logit.cv$PredictionCat, 
                       positive = "1")

```

# Principal Component Analysis

```{r determine pc}

pca_heroin <- heroin_net %>% 
  st_drop_geometry() %>% 
  select(Crimecount, Complaintscount, pharm.nn, hospital.nn, fast.nn, fuel.nn, rehab.nn, parks.nn, pop25_54, MedHHInc, MF_ratio, race_ratio, pctPoverty, pctBachelor)

pca_heroin <- na.omit(pca_heroin)
pc <- prcomp(pca_heroin,
             center = TRUE,
            scale. = TRUE)

summary(pc)
print(pc)
```

```{r pca viz}

fviz_eig(pc, addlabels = TRUE)
fviz_pca_var(pc, col.var = "black")
fviz_cos2(pc, choice = "var", axes = 1:7)

```

```{r compute pca}

pca_net <- heroin_net %>% 
  mutate(pc1 = Crimecount * pc$rotation[1] + Complaintscount * pc$rotation[2] + pharm.nn * pc$rotation[3] + hospital.nn * pc$rotation[4] + fast.nn * pc$rotation[5] +  fuel.nn * pc$rotation[6] + rehab.nn * pc$rotation[7] + parks.nn *  pc$rotation[8] + pop25_54 * pc$rotation[9] + MedHHInc * pc$rotation[10] + MF_ratio * pc$rotation[11] + race_ratio * pc$rotation[12] +  pctPoverty * pc$rotation[13] + pctBachelor * pc$rotation[14]) %>% 
  mutate(pc2 = Crimecount * pc$rotation[15] + Complaintscount * pc$rotation[16] + pharm.nn * pc$rotation[17] + hospital.nn * pc$rotation[18] + fast.nn * pc$rotation[19] +  fuel.nn * pc$rotation[20] + rehab.nn * pc$rotation[21] + parks.nn *  pc$rotation[22] + pop25_54 * pc$rotation[23] + MedHHInc * pc$rotation[24] + MF_ratio * pc$rotation[25] + race_ratio * pc$rotation[26] +  pctPoverty * pc$rotation[27] + pctBachelor * pc$rotation[28]) %>%
  mutate(pc3 = Crimecount * pc$rotation[29] + Complaintscount * pc$rotation[30] + pharm.nn * pc$rotation[31] + hospital.nn * pc$rotation[32] + fast.nn * pc$rotation[33] +  fuel.nn * pc$rotation[34] + rehab.nn * pc$rotation[35] + parks.nn *  pc$rotation[36] + pop25_54 * pc$rotation[37] + MedHHInc * pc$rotation[38] + MF_ratio * pc$rotation[39] + race_ratio * pc$rotation[40] +  pctPoverty * pc$rotation[41] + pctBachelor * pc$rotation[42]) %>%
  mutate(pc4 = Crimecount * pc$rotation[43] + Complaintscount * pc$rotation[44] + pharm.nn * pc$rotation[45] + hospital.nn * pc$rotation[46] + fast.nn * pc$rotation[47] +  fuel.nn * pc$rotation[48] + rehab.nn * pc$rotation[49] + parks.nn *  pc$rotation[50] + pop25_54 * pc$rotation[51] + MedHHInc * pc$rotation[52] + MF_ratio * pc$rotation[53] + race_ratio * pc$rotation[54] +  pctPoverty * pc$rotation[55] + pctBachelor * pc$rotation[56]) %>%
  mutate(pc5 = Crimecount * pc$rotation[57] + Complaintscount * pc$rotation[58] + pharm.nn * pc$rotation[59] + hospital.nn * pc$rotation[60] + fast.nn * pc$rotation[61] +  fuel.nn * pc$rotation[62] + rehab.nn * pc$rotation[63] + parks.nn *  pc$rotation[64] + pop25_54 * pc$rotation[65] + MedHHInc * pc$rotation[66] + MF_ratio * pc$rotation[67] + race_ratio * pc$rotation[68] +  pctPoverty * pc$rotation[69] + pctBachelor * pc$rotation[70]) %>%
  mutate(pc6 = Crimecount * pc$rotation[71] + Complaintscount * pc$rotation[72] + pharm.nn * pc$rotation[73] + hospital.nn * pc$rotation[74] + fast.nn * pc$rotation[75] +  fuel.nn * pc$rotation[76] + rehab.nn * pc$rotation[77] + parks.nn *  pc$rotation[78] + pop25_54 * pc$rotation[79] + MedHHInc * pc$rotation[80] + MF_ratio * pc$rotation[81] + race_ratio * pc$rotation[82] +  pctPoverty * pc$rotation[83] + pctBachelor * pc$rotation[84]) %>%
  mutate(pc7 = Crimecount * pc$rotation[85] + Complaintscount * pc$rotation[86] + pharm.nn * pc$rotation[87] + hospital.nn * pc$rotation[88] + fast.nn * pc$rotation[89] +  fuel.nn * pc$rotation[90] + rehab.nn * pc$rotation[91] + parks.nn *  pc$rotation[92] + pop25_54 * pc$rotation[93] + MedHHInc * pc$rotation[94] + MF_ratio * pc$rotation[95] + race_ratio * pc$rotation[96] +  pctPoverty * pc$rotation[97] + pctBachelor * pc$rotation[98])
  

```

# PCA Logistic Regression

```{r using pca in logistic regression}

reg.vars <- c("pc1", "pc2", "pc3", "pc4", "pc5", "pc6", "pc7")


pca.logit.cv <- logitCV (
  dataset = pca_net,
  id = "cvID",
  dependentVariable = "hotspot",
  indVariables = reg.vars) %>%
    dplyr::select(cvID = cvID, hotspot, Prediction, geometry)

pca.logit.cv <- pca.logit.cv %>% 
  mutate(PredictionCat  = as.factor(ifelse(pca.logit.cv$Prediction > 0.5 , 1, 0))) %>% 
  mutate(hotspot = as.factor(hotspot))

caret::confusionMatrix(pca.logit.cv$hotspot, pca.logit.cv$PredictionCat, 
                       positive = "1")
```


```{r ROC curve}

ggplot(pca.logit.cv, aes(d = as.numeric(hotspot), m = Prediction)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#2E4756") +
    labs(title = "ROC Curve for Improved Model") +
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = "#DBC2CF") +
  theme(plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"), 
        axis.text.x=element_text(size=8),
        axis.text.y=element_text(size=8), 
        axis.title=element_text(size=9), 
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, linewidth =0.8))
```

# KDE Validation

```{r KDE 1000 radii}

heroin_ppp <- as.ppp(st_coordinates(heroin), W = st_bbox(heroin_net))
heroin_KD.1000 <- spatstat.explore::density.ppp(heroin_ppp, 1000)
heroin_KD.df <- data.frame(rasterToPoints(mask(raster(heroin_KD.1000), as(cincinnati20, 'Spatial'))))


ggplot(data=heroin_KD.df, aes(x=x, y=y)) +
  geom_raster(aes(fill=layer)) + 
  coord_sf(crs=st_crs(heroin_net)) + 
  scale_fill_viridis(option = "magma", name="Density") +
  labs(title = "Kernel Density of Heroin 1000ft Radii") +
    theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks =element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, size=0.8)
        )
```

```{r comparison}

heroin_KDE_sum <- as.data.frame(heroin_KD.1000) %>%
  st_as_sf(coords = c("x", "y"), crs = st_crs(heroin_net)) %>%
  aggregate(., heroin_net, mean) 

kde_breaks <- classIntervals(heroin_KDE_sum$value, 
                             n = 2, "fisher")

heroin_KDE_sf <- heroin_KDE_sum %>%
  mutate(label = "Kernel Density",
         Risk_Category = classInt::findCols(kde_breaks),
         Risk_Category = case_when(
           Risk_Category == 2 ~ "High",
           Risk_Category == 1 ~ "Low"))

heroin_risk_sf <-
  pca.logit.cv %>%
  mutate(label = "Logistic Regression",
         Risk_Category = case_when(
           PredictionCat == 1 ~ "High",
           PredictionCat == 0 ~ "Low")) %>% 
  dplyr::select(PredictionCat, label, Risk_Category) %>% 
  rename(value = PredictionCat)


rbind(heroin_KDE_sf, heroin_risk_sf) %>%
  na.omit() %>%
  gather(Variable, Value, -label, -Risk_Category, -geometry) %>%
  ggplot() +
    geom_sf(aes(fill = Risk_Category), colour = NA) +
    facet_wrap(~label, ) +
    scale_fill_viridis(option = "magma", discrete = TRUE, name = "Risk Category") +
    #labs(title="Comparison of Kernel Density and Risk Predictions",
         #subtitle="2021 robbery risk predictions; 2022 robberies") + 
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks =element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, size=0.8)
        )
```

# Multi Criteria Analysis

```{r MCA}

scale_values <- function(x){(x-min(x))/(max(x)-min(x))}

risk_score <- heroin_net %>% 
  mutate(MedHHInc = ifelse(is.na(MedHHInc), 0, MedHHInc)) %>% 
  mutate(scl_crime = scale_values(Crimecount),
         scl_complaints = scale_values(Complaintscount),
         scl_pharm = scale_values(pharm.nn),
         scl_hospital = scale_values(hospital.nn),
         scl_rehab = scale_values(rehab.nn),
         scl_park = scale_values(parks.nn),
         scl_fuel = scale_values(fuel.nn),
         scl_fast = scale_values(fast.nn),
         scl_pop = scale_values(pop25_54),
         scl_income = scale_values(MedHHInc),
         scl_gender = scale_values(MF_ratio),
         scl_race = scale_values(race_ratio),
         scl_poverty = scale_values(pctPoverty),
         scl_edu = scale_values(pctBachelor)) %>% 
  mutate(scl_race_re = 0 - scl_race + 1,
         scl_edu_re = 0 - scl_edu + 1,
         scl_income_re = 0 - scl_income + 1, 
         scl_fuel_re = 0 - scl_fuel + 1,
         scl_fast_re = 0 - scl_fast + 1,
         scl_park_re = 0 - scl_park + 1,
         scl_pharm_re = 0 - scl_pharm + 1) %>% 
  mutate(score = 0.1 * (scl_hospital + scl_crime + scl_complaints +  scl_gender + scl_income_re + scl_fuel_re + scl_fast_re +  scl_park_re) + 0.05 * (scl_race_re +  scl_pharm_re) + 0.025*(scl_pop +scl_edu_re + scl_poverty +  scl_rehab)) %>% 
  st_as_sf()
  

neighborhood <- st_read(here("data", "public", "neighborhood.geojson")) %>% st_transform('ESRI:102728') %>% st_zm()

risk_score <- risk_score %>%
  left_join(net_centroid %>% dplyr::select(uniqueID) %>% 
               st_intersection(neighborhood %>% dplyr::select(SNA_NAME)) %>% 
              st_drop_geometry(), by = "uniqueID") %>% 
  mutate(SNA_NAME = ifelse(is.na(SNA_NAME), "NOT APPLICABLE", SNA_NAME))


```


```{r map risk}

pal <- colorBin(palette = "viridis", 
                domain = risk_score$score, 
                bins = c(0.2, 0.3, 0.4, 0.5, 0.6, 0.7)) 

labs <- paste0("<strong>", risk_score$SNA_NAME,
               "</strong><br/>Heorin-Overdose Risk Score: ", risk_score$score
               ) 

leaflet <- risk_score %>%
  st_transform("EPSG:4326") %>% 
  leaflet() %>%
  setView(lng = -84.51, lat = 39.10, zoom = 10.5) %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(weight = 1,
              fillColor = ~pal(score), # change the name of the parameter in the bracket
              popup = labs,
              fillOpacity = 1) %>%
  addLegend(position = "bottomright",
            pal = pal,
            values = ~risk_score, # change the name of the parameter after ~
            title = "Risk Score") # change the name of the legend 

leaflet

```


# References 

Choi, J. I., Lee, J., Yeh, A. B., Lan, Q., & Kang, H. (2022). Spatial clustering of heroin-related overdose incidents: a case study in Cincinnati, Ohio. BMC public health, 22(1), 1-12.

Srinivasan, S., Pustz, J., Marsh, E., Young, L. D., & Stopka, T. J. (2023). Risk factors for persistent fatal opioid-involved overdose hotspots in Massachusetts 2011-2021: A spatial statistical analysis with socio-economic, access and prescription factors.

Chichester, K. R., Drawve, G., Sisson, M., Giménez-Santana, A., McCleskey, B., Goodin, B. R., ... & Cropsey, K. L. (2023). Crime and Features of the Built Environment Predicting Risk of Fatal Overdose: A Comparison of Rural and Urban Ohio Counties with Risk Terrain Modeling. American Journal of Criminal Justice, 1-25.

